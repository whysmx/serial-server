# 更新日志

所有重要变更都会记录在此文件中。

## [v1.19.1] - 2025-12-31

### 🐛 Bug 修复

#### 串口扫描修复
- **修复 Windows 串口扫描问题**：改用 serial.OpenPort 替代 os.Open
- 解决 Windows 系统获取不到串口列表的问题

---

## [v1.19.0] - 2025-12-31

### ✨ 新功能

#### FRP 代理标记识别
- **添加 my_serial_server 标记**：使用 `my_serial_server = true` 配置项识别串口服务器代理
- **简化状态判断逻辑**：通过标记判断而非名称前缀
- **兼容旧配置**：只要有 `my_serial_server = xxx` 任意值即识别为串口服务器代理

---

## [v1.18.1] - 2025-12-31

### 🐛 Bug 修复

#### 菜单体验优化
- **Emoji 改为文字**：将 ✅/❌ 改为 打勾/打叉，解决 Windows 终端 emoji 显示不全问题
- **修复格式化错误**：Fprint 改用 Fprintf，修复菜单末尾显示 %s 问题
- **快捷键改为数字**：修改配置/编辑配置/重新加载 改为 1/2/0

#### 向导体验改进
- 向导参数确认：每个选项输入后显示实际使用的值
- 修改配置时：已配置的串口可重新选择，不再直接报错退出

---

## [v1.18.0] - 2025-12-31

### ✨ 新功能

#### 经典绿风格菜单
- **经典绿风格**：主菜单、FRP 管理菜单使用绿色主题
- **Emoji 状态显示**：已配置/FRP已添加使用 ✅，未配置/FRP未添加使用 ❌
- 配置摘要中的 FRP 状态根据实际状态显示绿色或红色
- 已配置的串口在列表中显示 ✅ 标记

### 🔧 改进

- 菜单标题、选项号、提示语统一使用绿色高亮
- FRP 操作成功/失败反馈使用对应颜色和 emoji
- 代码结构优化，提取颜色和 emoji 常量

---

## [v1.17.0] - 2025-12-31

### ✨ 新功能

#### FRP 状态显示
- 配置摘要自动检测 FRP 代理状态
- 显示 ✓ 表示已添加代理，✗ 表示未添加
- 根据 local_port 匹配判断状态

#### 配置摘要优化
- 配置摘要改用串口名称作为标识（如 COM2）
- 串口参数紧凑显示：`COM2:[9600 N 8 1 HEX]`
- 统一格式：`序号. 串口:[波特率 校验位 数据位 停止位 显示格式] 端口[服务端口] frp[状态]`

### 🔧 改进

#### 配置向导
- 添加新配置时跳过确认提示，直接进入添加流程
- 用户选择"添加新配置"后立即扫描串口

---

## [v1.16.1] - 2025-12-31

### 🐛 Bug 修复

#### 文档修复
- 修复 Mermaid 流程图标签显示问题

### 📝 文档

#### README 改进
- 在 README 中嵌入队列流程图

---

## [v1.13.0] - 2025-12-31

### ✨ 新功能

#### FRP 管理集成
- **集成 FRP 管理功能**
  - 添加命令行交互菜单（选项 5）
  - 支持添加 STCP 代理（自动使用配置中的端口号）
  - 支持查看当前 FRP 配置
  - FRP 包移至 `pkg/frp/` 目录

### 🐛 Bug 修复

#### TUI 移除
- **移除未使用的 TUI 图形界面**
  - 删除 `tui/` 目录及相关依赖
  - 清理不再使用的依赖包（tcell, go-colorful, go-runewidth, uniseg）
  - 简化项目结构

---

## [v1.12.5] - 2024-12-30

### 🔧 改进

#### 日志格式优化
- **长度显示改为纯数字**
  - 格式从 `[10B]` 改为 `[10]`
  - 更简洁，减少视觉干扰
  - 适用于所有显示格式（HEX/UTF8/GB2312）

---

## [v1.12.4] - 2024-12-30

### ✨ 新功能

#### 日志长度显示
- **添加数据长度显示**
  - 日志格式：`[device_1_#1] [→] [9B] 68 03 03 68...`
  - 在箭头和数据之间显示字节数（[9B] = 9 bytes）
  - 方便快速判断数据包大小
  - 适用于 TX 和 RX 两个方向

### 🔧 改进

#### 控制台输出简化
- **精简启动信息**
  - 移除 "查看日志: tail -f" 提示行
  - 只显示日志文件完整路径
  - 减少控制台输出冗余

---

## [v1.12.3] - 2024-12-30

### 🐛 Bug 修复

#### RWMutex 死锁修复
- **修复客户端连接时的死锁问题**
  - 在持有写锁时调用 getClientCount() 导致死锁
  - getClientCount() 内部尝试获取读锁，与写锁冲突
  - 修复：在释放锁前获取 count，然后在锁外调用 log.Printf
  - defer 块中也做了同样修复，避免调用 getClientCount()
  - 现在日志正常显示：`[listener:device_1] client connected 127.0.0.1:51164 -> #1 (total: 1)`
  - 数据传输日志正常：`[device_1_#1] [→] 74 65 73 74`

---

## [v1.12.2] - 2024-12-30

### 🐛 Bug 修复

#### 重复日志修复
- **移除重复的客户端连接日志**
  - 删除 acceptLoop 中的重复连接日志
  - 保留 handleClient 中的完整日志（带 clientIndex）
  - 避免日志混乱和潜在的并发问题
  - 确保日志格式统一为 `[listener:device_1] client connected 127.0.0.1:46726 -> #1 (total: 1)`

---

## [v1.12.1] - 2024-12-30

### 🐛 Bug 修复

#### Goroutine 死锁修复
- **修复 v1.12.0 引入的死锁问题**
  - goroutine 闭包中重复获取锁导致死锁
  - 在 goroutine 启动前捕获 clientIndex 作为参数
  - 避免在 goroutine 内部访问 shared map
  - 修复程序卡死无法退出的问题

---

## [v1.12.0] - 2024-12-30

### ✨ 新功能

#### 客户端序号显示
- **添加客户端连接序号**
  - 每个客户端连接分配独立序号 (#1, #2, #3...)
  - 每个设备独立计数客户端序号
  - 优化日志格式：`[device_1_#1] [→] data`
  - 更简洁直观，易于区分不同客户端连接

---

## [v1.11.1] - 2024-12-30

### 🐛 Bug 修复

#### TUI 移除
- **移除 TUI 图形界面**
  - 简化程序为纯日志后台模式
  - 移除 --tui 参数和所有 TUI 相关代码
  - 移除 tui 包导入和相关全局变量
  - 移除 reloadConfig 函数（不再需要热重载）
  - 修改配置需要编辑 config.ini 并重启程序

---

## [v1.11.0] - 2024-12-30

### ✨ 新功能

#### TUI 运行时配置管理
- **默认启动 TUI 界面**
  - 无需 `--tui` 参数，直接启动图形界面
  - 更友好的用户体验，适合交互式使用
  - 需要日志模式时使用 `--tui=false`

- **TUI 菜单配置管理**
  - `[A]` 添加监听器 - 动态添加新的串口监听器
  - `[D]` 删除监听器 - 删除选中的监听器
  - `[E]` 编辑监听器 - 编辑所有配置参数（8个字段）
  - `[S]` 保存并重载 - 热重载配置，无需重启程序

#### 多客户端日志区分
- **日志格式优化**
  - 日志显示客户端 ID：`[device_1] [→] [client:127.0.0.1:54321] data`
  - 每个客户端独立数据缓冲
  - TUI 每行数据显示客户端标识

#### 自动化发布改进
- **更新 CHANGELOG 自动化**
  - `/release` 命令自动更新 CHANGELOG.md
  - 分析 git commits 生成结构化更新日志
  - 智能分类：新功能/Bug修复/改进等

---

## [v1.9.0] - 2024-12-30

### ✨ 新功能

#### 简化配置
- **移除 max_clients 配置参数**
  - 统一使用多客户端队列模式
  - 配置文件更简洁，用户无需理解单/多客户端区别
  - 向导不再询问客户端模式选择

#### 改进
- **简化连接处理逻辑**
  - 移除单客户端踢旧连接的代码
  - 新连接直接接受，无需检查数量限制
  - 代码更简洁，行为更直观

### 📝 文档
- 更新配置示例，移除 max_clients 参数
- 更新 README 和 DESIGN.md 文档

---

## [v1.8.3] - 2024-12-30

### 🐛 Bug 修复

#### 日志优化
- **修复 EOF 日志泛滥问题**
  - 设置 ReadTimeout 后，每次超时返回 EOF
  - 将 EOF 视为正常的帧间隔检测信号，不再记录错误日志
  - 解决大量 `[listener:device_1] serial read error: EOF` 日志输出
  - 有缓冲数据时仍正常提交完整帧

---

## [v1.8.2] - 2024-12-30

### 🐛 Bug 修复

#### 串口通信
- **修复串口数据分包问题**
  - 实现帧缓冲机制，累积不完整的串口数据
  - 使用 50ms 读取超时检测帧间隔
  - 解决因 `serial.Read()` 返回部分数据导致响应不完整的问题
  - 示例：`68` 只有 1 字节 → 累积后完整 `68 68 36 36 68 ...`（49字节）

#### 界面优化
- **箭头符号优化**
  - 日志中的 `>>` 改为 `→`（发送）
  - 日志中的 `<<` 改为 `←`（接收）

---

## [v1.8.1] - 2024-12-30

### 🐛 Bug 修复

#### 核心架构
- **重构为"单一完成者"模型**（Single Finisher Pattern）
  - 使用 `atomic.Bool` 确保每个请求的响应通道只关闭一次
  - 避免并发操作导致的 double close / send on closed channel panic
  - 移除不可靠的 `select` 通道状态探测，不吞缓冲数据
  - 统一 `finishWithResponse()` 和 `finishNoResponse()` 完成方法

#### 并发安全
- **修复监听器启动失败时的资源泄漏**
  - 启动失败时停止已启动的监听器，避免端口占用
  - 清理定时器 goroutine 泄漏
  - 修复重复停止定时器的 panic（使用 `sync.Once`）

#### 数据一致性
- **修复串口数据重复记录/展示**
  - `serialReadLoop` 中的 `fireOnData` 调用重复
  - 统一在客户端响应处理时记录，避免统计偏差

#### 串口配置
- **串口参数正确应用**
  - `data_bits`、`stop_bits`、`parity` 参数被忽略的问题
  - 添加参数验证和错误提示
  - `rtscts` 不支持时输出警告日志

#### 队列机制
- **修复请求超时后队列停滞**
  - `CleanupExpired` 移除超时请求后自动触发下一条
  - 避免后续请求永久卡住
- **修复串口写入失败的并发处理**
  - 失败时从队列移除请求，避免重复操作
  - 自动触发下一条请求发送

#### TUI 界面
- **修复方向判断大小写不一致**
  - 回调传入 `tx`/`rx`（小写），但 TUI 判断 `TX`（大写）
  - 在 `AddData` 中统一转换为大写
- **修复焦点高亮计算错误**
  - 使用屏幕列 `x` 而非监听器索引 `i` 计算焦点
  - 导致焦点提示错乱
- **删除未使用的 `headerStr` 变量**
  - 避免 Go 编译错误

#### 配置管理
- **支持多监听器配置编辑**
  - 交互式"修改配置"只能编辑第一个监听器
  - 添加监听器列表选择功能
- **修复格式化占位符错误**
  - `fmt.Fprint` 包含 `%d` 占位符，导致原样输出
  - 改为 `fmt.Fprintf`

#### 文档
- **更正数据流转描述**
  - 从"广播给所有客户端"改为"请求-响应匹配返回给对应客户端"

---

## [v1.8.0] - 2024-12-XX

### ✨ 新功能

#### 多客户端队列系统
- 实现 FIFO 请求队列，支持多客户端并发连接
- 请求-响应匹配机制，确保响应返回正确的客户端
- 5 秒 TTL 响应缓存，相同数据请求直接命中缓存
- 3 秒请求超时自动清理，避免队列阻塞

#### TUI 终端界面
- 实现终端图形界面（基于 `tcell`）
- 顶部导航栏显示监听器状态和统计信息
- 支持 Tab/数字键切换监听器焦点
- 菜单系统：清屏、退出等功能
- TX/RX 数据分色显示

#### 显示格式增强
- 支持紧凑模式：50ms 内数据显示在一行
- 使用箭头 `>>` 表示发送，`<<` 表示接收

### 🔧 改进

#### 启动优化
- 添加启动超时机制（2 秒），避免程序退出时卡死
- 改进监听器启动流程，失败时清理资源

#### 日志系统
- 日志文件轮转，避免日志文件过大
- 添加时间戳到日志输出

---

## [v1.7.1] - 2024-XX-XX

### 🐛 Bug 修复
- 修复配置文件路径解析问题
- 修复串口设备在某些平台无法识别的问题

---

## [v1.7.0] - 2024-XX-XX

### ✨ 新功能
- 添加交互式配置向导（`--wizard`）
- 支持配置文件验证（`--check`）

---

## [v1.6.1] - 2024-XX-XX

### 🐛 Bug 修复
- 修复 Windows 平台串口设备名称解析
- 修复 HEX 显示格式问题

---

## [v1.6.0] - 2024-XX-XX

### ✨ 新功能
- 支持多串口设备同时映射
- 添加 GB2312 编码支持

---

## [v1.5.0] - 2024-XX-XX

### ✨ 新功能
- 初始版本发布
- 基本的 TCP ↔ Serial 透传功能
- HEX/UTF8 显示格式支持
- 单客户端/多客户端模式

---

## 版本号说明

版本号遵循 **语义化版本 2.0.0** 格式：`MAJOR.MINOR.PATCH`

- **MAJOR**：不兼容的 API 变更
- **MINOR**：向下兼容的功能新增
- **PATCH**：向下兼容的 Bug 修复

---

## 问题分类符号

- 🐛 **Bug 修复** - 修复错误行为
- ✨ **新功能** - 新增功能
- 🔧 **改进** - 优化现有功能
- 📝 **文档** - 文档更新
- ♻️ **重构** - 代码重构（不改变功能）
- ⚡ **性能** - 性能优化
- 🔒 **安全** - 安全相关修复
